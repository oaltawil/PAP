{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "dnsLabelPrefix": {
      "type": "string",
      "metadata": {
        "description": "Unique DNS prefix for the RD Gateway FQDN. The FQDN will look something like '<dnsLabelPrefix>.<existingDomainName>'. For example johndns1 will result in the following RDWEB Access URL:  https://johndns1.contoso.com/RDWeb"
      }
    },
    "existingDomainName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Active Directory domain. For example contoso.com"
      }
    },
    "existingDnsServer": {
      "type": "string",
      "metadata": {
        "description": "Name of the DNS Server; required for adding the DNS entries for the Connection Brokers' Client Access Name"
      }
    },
    "_artifactsLocation": {
      "type": "string",
      "metadata": {
        "description": "Base URI where artifacts required by this template are located"
      },
      "defaultValue": "https://raw.githubusercontent.com/oaltawil/PAP/master"
    }
  },
    "variables": {
      "vmPrefix": "",
      "gatewayVmName": "[concat(variables('vmPrefix'), 'rdgw-')]",
      "primaryGatewayVmName": "[concat(variables('gatewayVmName'), '01')]",
      "loadBalancerIP": "10.0.2.11"
  },
    "resources": [
      {
        "name": "[concat(variables('primaryGatewayVMName'),'/RegisterRdGatwayFqdnDns.ps1')]",
        "type": "Microsoft.Compute/virtualMachines/extensions",
        "location": "[resourceGroup().location]",
        "apiVersion": "2018-06-01",
        "dependsOn": [],
        "properties": {
          "publisher": "Microsoft.Compute",
          "type": "CustomScriptExtension",
          "typeHandlerVersion": "1.8",
          "autoUpgradeMinorVersion": true,
          "settings": {
            "fileUris": [
              "[concat(parameters('_artifactsLocation'),'/Scripts/RegisterRdGatwayFqdnDns.ps1')]"
            ]
          },
          "protectedSettings": {
            "commandToExecute": "[Concat('powershell.exe -ExecutionPolicy Unrestricted -File', ' ', 'RegisterRdGatwayFqdnDns.ps1',' ','-dnsLabelPrefix \"', parameters('dnsLabelPrefix'), '\" ','-existingDomainName \"',parameters('existingDomainName'),'\" ','-existingDnsServer \"',parameters('existingDnsServer'),'\" ','-loadBalancerIP ', variables('loadBalancerIP'))]"
          }
        }
      }
    ],
    "outputs": {
        "fqdn": {
          "type": "string",
          "value": "[concat(parameters('dnsLabelPrefix'), '.', parameters('existingDomainName'))]"
        }
    }
}